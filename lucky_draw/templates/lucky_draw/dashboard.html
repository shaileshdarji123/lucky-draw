{% extends 'lucky_draw/base.html' %}

{% block title %}Dashboard - Staff Party Lucky Draw{% endblock %}

{% block content %}
<div class="container">
    <input type="hidden" id="csrf-token" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center text-white mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>HR Dashboard
            </h1>
        </div>
    </div>
    {% if event_settings.day1_date and event_settings.day2_date %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info text-center" style="font-size:1.1rem;">
                <i class="fas fa-calendar-alt me-2"></i>
                <strong>Event Dates:</strong>
                Day 1: <span class="fw-bold">{{ event_settings.day1_date }}</span> &nbsp;|
                Day 2: <span class="fw-bold">{{ event_settings.day2_date }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Statistics Cards -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-number">{{ total_staff }}</div>
                <div class="stats-label">Total Staff</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-number text-success">{{ day1_checkins }}</div>
                <div class="stats-label">Day 1 Check-ins</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-number text-warning">{{ day2_checkins }}</div>
                <div class="stats-label">Day 2 Check-ins</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-number text-info">{{ day1_winners|add:day2_winners }}</div>
                <div class="stats-label">Total Winners</div>
            </div>
        </div>
    </div>
    
    <!-- Main Features -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card feature-card" onclick="window.location.href='{% url 'upload_staff' %}'">
                <div class="feature-icon">
                    <i class="fas fa-upload"></i>
                </div>
                <h5 class="fw-bold">Upload Staff List</h5>
                <p class="text-muted">Upload Excel/CSV file with staff information</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card feature-card" onclick="window.location.href='{% url 'scan_qr' %}'">
                <div class="feature-icon">
                    <i class="fas fa-qrcode"></i>
                </div>
                <h5 class="fw-bold">Scan QR Code</h5>
                <p class="text-muted">Check-in staff using QR codes</p>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card feature-card" onclick="window.location.href='{% url 'download_qr_codes' %}'">
                <div class="feature-icon">
                    <i class="fas fa-download"></i>
                </div>
                <h5 class="fw-bold">Download QR Codes</h5>
                <p class="text-muted">View and download QR codes for distribution</p>
            </div>
        </div>
        
        {% if clear_db_enabled %}
        <div class="col-md-4 mb-4">
            <div class="card feature-card bg-danger text-white" onclick="window.location.href='{% url 'clear_database' %}'">
                <div class="feature-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h5 class="fw-bold">Clear Database</h5>
                <p class="text-white">Delete all staff, check-ins, winners, and settings</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Lucky Draw Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-center mb-4">
                        <i class="fas fa-gift me-2"></i>Lucky Draw
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-warning btn-lg" onclick="drawWinner(1)" {% if not can_draw_day1 %}disabled{% endif %}>
                                    <i class="fas fa-star me-2"></i>Draw Winner - Day 1
                                </button>
                                {% if not can_draw_day1 %}
                                <div class="alert alert-warning mt-2 py-2 px-3 text-center">
                                    {{ draw_msg_day1 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-grid">
                                <button class="btn btn-warning btn-lg" onclick="drawWinner(2)" {% if not can_draw_day2 %}disabled{% endif %}>
                                    <i class="fas fa-star me-2"></i>Draw Winner - Day 2
                                </button>
                                {% if not can_draw_day2 %}
                                <div class="alert alert-warning mt-2 py-2 px-3 text-center">
                                    {{ draw_msg_day2 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div id="winner-display" class="winner-display" style="display: none;">
                        <div class="winner-name" id="winner-name"></div>
                        <div class="winner-dept" id="winner-dept"></div>
                        <div class="mt-3">
                            <small>Winner #<span id="winner-order"></span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Features -->
    <div class="row mt-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-list-check me-2"></i>View Check-ins
                    </h5>
                    <p class="card-text">See who has checked in for each day</p>
                    <a href="{% url 'view_checkins' %}" class="btn btn-primary">
                        <i class="fas fa-eye me-2"></i>View Check-ins
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-trophy me-2"></i>View Winners
                    </h5>
                    <p class="card-text">See all lucky draw winners</p>
                    <a href="{% url 'view_winners' %}" class="btn btn-primary">
                        <i class="fas fa-eye me-2"></i>View Winners
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<script src="/static/js/winner_announce.js"></script>
<script>
function drawWinner(day) {
    fetch('{% url "draw_winner" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrf-token').value
        },
        body: JSON.stringify({day: day})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show animated winner announcement
            animateWinnerReveal(data.winner_name, data.department);
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while drawing the winner.');
    });
}
</script>
{% endblock %}
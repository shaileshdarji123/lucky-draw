{% extends 'lucky_draw/base.html' %}

{% block title %}Download QR Codes - Staff Party Lucky Draw{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <form method="get" class="row g-2 align-items-end mb-2">
                <div class="col-md-6">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" name="search" id="search" class="form-control" placeholder="Search by name, department, or day" value="{{ search_query }}">
                        <button type="submit" class="btn btn-outline-primary"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label for="department" class="form-label">Department</label>
                    <select name="department" id="department" class="form-select">
                        <option value="">All</option>
                        {% for dept in departments %}
                            <option value="{{ dept }}" {% if dept == department_filter %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="day" class="form-label">Day</label>
                    <select name="day" id="day" class="form-select">
                        <option value="">All</option>
                        {% for d in days %}
                            <option value="{{ d }}" {% if d|stringformat:'s' == day_filter %}selected{% endif %}>Day {{ d }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="checked_in" class="form-label">Checked-in</label>
                    <select name="checked_in" id="checked_in" class="form-select">
                        <option value="">Show All</option>
                        <option value="hide" {% if checked_in_filter == 'hide' %}selected{% endif %}>Hide Checked-in</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-download fa-3x text-primary mb-3"></i>
                        <h3 class="fw-bold">Download QR Codes</h3>
                        <p class="text-muted">View and download QR codes for staff distribution</p>
                    </div>
                    {% if staff_list %}
                        <div id="filter-info-row" class="d-flex justify-content-between align-items-center mb-2" style="display: none;">
                            <div>
                                <span class="fw-bold">Showing <span id="staff-count">{{ page_obj.end_index }}</span> staff</span>
                                <span class="text-muted ms-2" id="active-filters-badges">
                                    {% if search_query %}Search: <span class="badge bg-info text-dark">{{ search_query }}</span>{% endif %}
                                    {% if department_filter %}Department: <span class="badge bg-info text-dark">{{ department_filter }}</span>{% endif %}
                                    {% if day_filter %}Day: <span class="badge bg-info text-dark">{{ day_filter }}</span>{% endif %}
                                    {% if checked_in_filter %}Checked-in: <span class="badge bg-info text-dark">{{ checked_in_filter }}</span>{% endif %}
                                </span>
                            </div>
                            <div>
                                <a href="#" id="clear-filters-btn" class="btn btn-outline-secondary btn-sm">Clear Filters</a>
                            </div>
                        </div>
                        <div class="row" id="staff-cards-container" style="min-height: 200px;">
                            <!-- Staff cards will be loaded here by JS -->
                        </div>
                        <div id="loading-indicator" class="text-center my-2" style="height: 50px; visibility: visible;">
                            <span class="spinner-border spinner-border-sm text-primary"></span>
                            <span class="ms-2 text-muted small">Loading more...</span>
                        </div>
                        <div class="text-center mt-4">
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Staff Members Found</h5>
                            <p class="text-muted">Upload a staff list first to generate QR codes.</p>
                            <a href="{% url 'upload_staff' %}" class="btn btn-primary">
                                <i class="fas fa-upload me-2"></i>Upload Staff List
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="current-page-json">{{ page_obj.number }}</script>
<script type="application/json" id="last-page-json">{{ paginator.num_pages }}</script>
<script type="application/json" id="staff-list-json">{{ staff_list_json|safe }}</script>
<script>
let isLoading = false;
let currentPage = JSON.parse(document.getElementById('current-page-json').textContent);
let lastPage = JSON.parse(document.getElementById('last-page-json').textContent);
let initialStaffList = [];
try {
    initialStaffList = JSON.parse(document.getElementById('staff-list-json').textContent);
} catch (e) {
    console.error('Failed to parse initial staff list JSON:', e);
}

// Debounced AJAX search and filter
let searchTimeout = null;
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                runFilterAjax();
            }, 400); // 400ms debounce
        });
    }
    // Filter change handler
    ['department', 'day', 'checked_in'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', function() {
                runFilterAjax();
            });
        }
    });
    // Clear Filters button handler
    const clearBtn = document.getElementById('clear-filters-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('department').value = '';
            document.getElementById('day').value = '';
            document.getElementById('checked_in').value = '';
            document.getElementById('search').value = '';
            runFilterAjax();
        });
    }
    updateFilterInfoRow();
});

function updateFilterInfoRow() {
    // Show/hide filter info row based on active filters
    const department = document.getElementById('department').value;
    const day = document.getElementById('day').value;
    const checked_in = document.getElementById('checked_in').value;
    const search = document.getElementById('search').value;
    const filterRow = document.getElementById('filter-info-row');
    if (filterRow) {
        if (department || day || checked_in || search) {
            filterRow.style.display = 'flex';
        } else {
            filterRow.style.display = 'none';
        }
    }
    // Update badges
    const badges = [];
    if (search) badges.push(`Search: <span class='badge bg-info text-dark'>${search}</span>`);
    if (department) badges.push(`Department: <span class='badge bg-info text-dark'>${department}</span>`);
    if (day) badges.push(`Day: <span class='badge bg-info text-dark'>${day}</span>`);
    if (checked_in) badges.push(`Checked-in: <span class='badge bg-info text-dark'>${checked_in}</span>`);
    const badgesEl = document.getElementById('active-filters-badges');
    if (badgesEl) badgesEl.innerHTML = badges.join(' ');
}

function runFilterAjax() {
    isLoading = false;
    currentPage = 1;
    lastPage = 1;
    document.getElementById('staff-cards-container').innerHTML = '';
    // Reset loading indicator to default
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span><span class="ms-2 text-muted small">Loading more...</span>';
        loadingIndicator.style.height = '50px';
        loadingIndicator.style.display = 'block';
    }
    let params = new URLSearchParams();
    params.set('department', document.getElementById('department').value);
    params.set('day', document.getElementById('day').value);
    params.set('checked_in', document.getElementById('checked_in').value);
    params.set('search', document.getElementById('search').value);
    params.set('page', 1);
    params.set('ajax', 1);
    params.set('per_page', calculateItemsPerPage());
    fetch(window.location.pathname + '?' + params.toString())
        .then(res => res.json())
        .then(data => {
            let loaded = 0;
            const container = document.getElementById('staff-cards-container');
            container.innerHTML = '';
            if (Array.isArray(data.staff_list)) {
                data.staff_list.forEach(staff => {
                    container.appendChild(renderStaffCard(staff));
                    loaded++;
                });
            }
            // Update staff count
            let staffCountEl = document.getElementById('staff-count');
            if (staffCountEl) {
                staffCountEl.textContent = loaded;
            }
            lastPage = data.num_pages;
            // Hide loading indicator if no more pages
            if (currentPage >= lastPage) {
                loadingIndicator.innerHTML = '<div class="text-muted small py-2"><i class="fas fa-check-circle me-1"></i>All staff loaded</div>';
                loadingIndicator.style.height = 'auto';
                loadingIndicator.style.display = 'block';
            } else {
                loadingIndicator.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span><span class="ms-2 text-muted small">Loading more...</span>';
                loadingIndicator.style.height = '50px';
                loadingIndicator.style.display = 'block';
            }
            updateFilterInfoRow();
            // Re-attach lazy loading observer for new filter set
            setupLazyLoading();
        });
}

// Calculate how many items fit in the viewport based on screen size
function calculateItemsPerPage() {
    // Get container width
    const containerWidth = document.getElementById('staff-cards-container').clientWidth;
    
    // Determine how many cards fit horizontally (Bootstrap breakpoints)
    // Bootstrap col-lg-3 = 4 cards per row on large screens (≥992px)
    // Bootstrap col-md-4 = 3 cards per row on medium screens (≥768px)
    // Otherwise 1-2 cards per row on small screens
    let cardsPerRow = 1;
    if (containerWidth >= 992) {
        cardsPerRow = 4; // Large screens: 4 cards per row
    } else if (containerWidth >= 768) {
        cardsPerRow = 3; // Medium screens: 3 cards per row
    } else if (containerWidth >= 576) {
        cardsPerRow = 2; // Small screens: 2 cards per row
    }
    
    // Calculate viewport height and approximate card height (300px + margins)
    const viewportHeight = window.innerHeight;
    const cardHeight = 350; // Approximate height including margins
    
    // Calculate how many rows fit in viewport (round up to ensure complete rows)
    const rowsInViewport = Math.ceil(viewportHeight / cardHeight);
    
    // Calculate total cards that fit in viewport (add one extra row as buffer)
    const itemsPerPage = cardsPerRow * (rowsInViewport + 1);
    
    // Return a reasonable minimum (ensure at least 4 cards)
    return Math.max(itemsPerPage, 4);
}
function calculateItemsPerPage() {
    // Get container width
    const containerWidth = document.getElementById('staff-cards-container').clientWidth;
    
    // Determine how many cards fit horizontally (Bootstrap breakpoints)
    // Bootstrap col-lg-3 = 4 cards per row on large screens (≥992px)
    // Bootstrap col-md-4 = 3 cards per row on medium screens (≥768px)
    // Otherwise 1-2 cards per row on small screens
    let cardsPerRow = 1;
    if (containerWidth >= 992) {
        cardsPerRow = 4; // Large screens: 4 cards per row
    } else if (containerWidth >= 768) {
        cardsPerRow = 3; // Medium screens: 3 cards per row
    } else if (containerWidth >= 576) {
        cardsPerRow = 2; // Small screens: 2 cards per row
    }
    
    // Calculate viewport height and approximate card height (300px + margins)
    const viewportHeight = window.innerHeight;
    const cardHeight = 350; // Approximate height including margins
    
    // Calculate how many rows fit in viewport (round up to ensure complete rows)
    const rowsInViewport = Math.ceil(viewportHeight / cardHeight);
    
    // Calculate total cards that fit in viewport (add one extra row as buffer)
    const itemsPerPage = cardsPerRow * (rowsInViewport + 1);
    
    console.log(`Viewport calculation: ${cardsPerRow} cards per row × ${rowsInViewport+1} rows = ${itemsPerPage} cards per page`);
    
    // Return a reasonable minimum (ensure at least 4 cards)
    return Math.max(itemsPerPage, 4);
}

function renderStaffCard(staff) {
    let checkedIn = staff.checked_in;
    let card = document.createElement('div');
    card.className = 'col-md-4 col-lg-3 mb-4';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    card.innerHTML = `
        <div class="card h-100${checkedIn ? ' border-secondary bg-light' : ''}">
            <div class="card-body text-center">
                <h6 class="card-title${checkedIn ? ' text-secondary' : ''}">${staff.name}</h6>
                <p class="text-muted small">${staff.department}</p>
                <p class="badge ${checkedIn ? 'bg-secondary' : 'bg-primary'}">Day ${staff.day_1}</p>
                <div class="mt-3">
                    <img src="/preview-qr-svg/${staff.id}/" alt="QR Code for ${staff.name}" class="img-fluid${checkedIn ? ' opacity-50' : ''}" style="max-width: 150px;">
                </div>
                <div class="mt-3 d-flex ${checkedIn ? 'flex-column align-items-center gap-2' : 'justify-content-center gap-2'}">
                    ${checkedIn ? `<div class='alert alert-secondary w-100 mb-2 p-2'><i class='fas fa-check-circle me-1'></i> Checked-in</div>` : `
                        <a href="/download-qr-with-label/${staff.id}/" class="btn btn-sm btn-outline-primary" download><i class="fas fa-download me-1"></i>Download JPG</a>
                        <form method="post" class="delete-staff-form" data-staff-id="${staff.id}" style="display:inline;">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <button type="submit" class="btn btn-sm btn-outline-danger delete-staff-btn"><i class="fas fa-trash"></i> Delete</button>
                        </form>
                    `}
                </div>
            </div>
        </div>
    `;
    return card;
}

function loadNextPage() {
    if (isLoading || currentPage >= lastPage) {
        console.log(`Not loading next page: isLoading=${isLoading}, currentPage=${currentPage}, lastPage=${lastPage}`);
        return;
    }
    isLoading = true;
    currentPage += 1;
    console.log(`Loading page ${currentPage} of ${lastPage}...`);
    document.getElementById('loading-indicator').style.display = 'block';
    // Calculate how many items to request based on viewport size
    const itemsPerPage = calculateItemsPerPage();
    // Build request URL with dynamic page size and current filters
    let params = new URLSearchParams();
    params.set('department', document.getElementById('department').value);
    params.set('day', document.getElementById('day').value);
    params.set('checked_in', document.getElementById('checked_in').value);
    params.set('search', document.getElementById('search').value);
    params.set('page', currentPage);
    params.set('ajax', 1);
    params.set('per_page', itemsPerPage);
    const url = window.location.pathname + '?' + params.toString();
    console.log(`Fetching URL: ${url} (${itemsPerPage} items per page)`);
    fetch(url)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log(`Received data for page ${currentPage}:`, data);
            let loaded = 0;
            if (Array.isArray(data.staff_list)) {
                data.staff_list.forEach(staff => {
                    document.getElementById('staff-cards-container').appendChild(renderStaffCard(staff));
                    loaded++;
                });
            } else {
                console.error('Expected staff_list to be an array but got:', data.staff_list);
            }
            // Update staff count
            let staffCountEl = document.getElementById('staff-count');
            if (staffCountEl) {
                let currentCount = parseInt(staffCountEl.textContent) || 0;
                staffCountEl.textContent = currentCount + loaded;
            }
            lastPage = data.num_pages;
            isLoading = false;
            // Only hide the loading indicator if we've reached the last page
            if (currentPage >= lastPage) {
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.innerHTML = '<div class="text-muted small py-2"><i class="fas fa-check-circle me-1"></i>All staff loaded</div>';
                loadingIndicator.style.height = 'auto';
                console.log('Reached last page, showing completion message');
            } else {
                document.getElementById('loading-indicator').style.display = 'block';
            }
            // If no more staff, show fallback
            if (currentPage >= lastPage && document.getElementById('staff-cards-container').children.length === 0) {
                document.getElementById('staff-cards-container').innerHTML = '<div class="text-center py-5"><i class="fas fa-users fa-3x text-muted mb-3"></i><h5 class="text-muted">No Staff Members Found</h5></div>';
                console.log('No more pages and no staff found, showing fallback message');
            }
        })
        .catch(error => {
            console.error('Error loading next page:', error);
            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'block';
        });
}

function setupLazyLoading() {
    // Create an IntersectionObserver that only triggers when the loading indicator 
    // is just entering the viewport, without preloading ahead
    let observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                console.log('Loading indicator is visible, loading next page...');
                loadNextPage();
            }
        });
    }, { 
        // Only trigger when the element is very close to viewport
        threshold: 0.1,    // Only need 10% visibility to trigger
        rootMargin: '0px'  // No extra margin - only load when actually in viewport
    });
    
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        observer.observe(loadingIndicator);
        console.log('Observer attached to loading indicator');
    } else {
        console.error('Loading indicator not found!');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    
    // Calculate optimal items per page for current viewport
    const itemsPerPage = calculateItemsPerPage();
    console.log(`Viewport optimized for ${itemsPerPage} items per page`);
    
    // Initialize lazy loading
    setupLazyLoading();
    
    // Initialize lazy loading
    setupLazyLoading();
    
    // Add window resize handler to recalculate items per page on window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        // Debounce the resize event to avoid excessive recalculation
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            const newItemsPerPage = calculateItemsPerPage();
            console.log(`Window resized: viewport now optimized for ${newItemsPerPage} items per page`);
            // No need to reload current content - just ensure future loads use the new page size
        }, 250); // Wait 250ms after resize stops before recalculating
    });
    
    // Initial load: render first page from context
    let loaded = 0;
    const staffCardsContainer = document.getElementById('staff-cards-container');
    
    if (Array.isArray(initialStaffList) && initialStaffList.length > 0) {
        console.log(`Rendering ${initialStaffList.length} initial staff cards`);
        initialStaffList.forEach(staff => {
            if (staffCardsContainer) {
                staffCardsContainer.appendChild(renderStaffCard(staff));
                loaded++;
            }
        });
        console.log(`Rendered ${loaded} initial staff cards`);
    } else {
        console.warn('initialStaffList is empty or not an array:', initialStaffList);
        // If initial staff list is empty but we have more pages, attempt to load the first page
        if (lastPage > 0) {
            console.log('Attempting to load first page via AJAX');
            currentPage = 0; // Reset to load page 1
            loadNextPage();
        }
    }
    
    // Update staff count
    let staffCountEl = document.getElementById('staff-count');
    if (staffCountEl) {
        staffCountEl.textContent = loaded;
    }
    
    // Fallback if no staff
    if (loaded === 0 && staffCardsContainer) {
        staffCardsContainer.innerHTML = '<div class="text-center py-5"><i class="fas fa-users fa-3x text-muted mb-3"></i><h5 class="text-muted">No Staff Members Found</h5></div>';
        console.warn('No staff cards rendered on initial load.');
    }
    
    // Delete staff handler
    if (staffCardsContainer) {
        staffCardsContainer.addEventListener('submit', function(e) {
            if (e.target.classList.contains('delete-staff-form')) {
                e.preventDefault();
                if (!confirm('Are you sure you want to delete this staff member and their QR code?')) return;
                const staffId = e.target.getAttribute('data-staff-id');
                const csrfToken = e.target.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                fetch(`/delete-staff/${staffId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        e.target.closest('.col-md-4, .col-lg-3').remove();
                    } else {
                        alert(data.message || 'Failed to delete staff.');
                    }
                })
                .catch(() => alert('Failed to delete staff.'));
            }
        });
    }
});
// JSON script blocks for safe JS variable assignment
</script>
{% endblock %}